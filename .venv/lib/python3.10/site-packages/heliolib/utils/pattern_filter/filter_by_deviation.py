import logging

import pandas as pd

logger = logging.getLogger(__name__)


def filter_by_deviation(
    df: pd.DataFrame, deviation_degree=0.1, filter_within_sensitivity_tolerance=True
) -> pd.DataFrame:
    """
    This function filters out the datapoints from the dataframe which is having the deviation, normalized columns of the current columns
    and filters out the datapoints with deviation_degree.
    This function can be used after using the normalize_and_calculate_deviation_between_two_columns function.

    Parameters:
    ------------
    df (pd.DataFrame):
        Normalized dataframe which is having deviation columns and its values of the columns.
    deviation_degree (float, optional):
        Tolerance level for deviation filtering (default is 0.1).
    filter_within_sensitivity_tolerance (bool, optional):
        * If True, retains data within the sensitivity tolerance;
        * if False, retains data exceeding the sensitivity tolerance (default is True).

    Returns:
    --------
    pd.DataFrame:
        returns filtered dataframe.

        Example:
             filtered_data = filter_by_deviation(df, deviation_degree=0.1, filter_within_sensitivity_tolerance=True)

     INPUT dataframe:
                            +---+-----+-----+--------+---------+--------------+
                           |   | col1| col2|col1_norm|col2_norm|col1_col2_dev|
                           |---|-----|-----|---------|---------|-------------|
                           | 0 | 1.0 | 1.0 |   1.0   |   1.0   |     0.0     |
                           | 1 | 1.0 | 1.0 |   1.0   |   1.0   |     0.0     |
                           | 2 | 1.0 | 1.0 |   1.0   |   1.0   |     0.0     |
                           | 3 | 1.0 | 1.0 |   1.0   |   1.0   |     0.0     |
                           +---+-----+-----+---------+---------+--------------+

     OUTPUT dataframe:
                    +---+-----+-----+--------+---------+--------------+
                   |   | col1| col2|col1_norm|col2_norm|col1_col2_dev|
                   |---|-----|-----|---------|---------|-------------|
                   | 0 | 1.0 | 1.0 |   1.0   |   1.0   |     0.0     |
                   | 1 | 1.0 | 1.0 |   1.0   |   1.0   |     0.0     |
                   | 3 | 1.0 | 1.0 |   1.0   |   1.0   |     0.0     |
                   +---+-----+-----+---------+---------+--------------+

    """
    master = df.columns[0]
    slave = df.columns[1]

    dev_column_string = "_dev"

    if filter_within_sensitivity_tolerance:
        df = df[df[master + "_" + slave + dev_column_string] < deviation_degree]
    else:
        df = df[df[master + "_" + slave + dev_column_string] >= deviation_degree]

    return df
