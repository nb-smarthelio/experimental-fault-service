import os

import pandas as pd
import pytest

from .excel_data_extraction import ExcelDataExtractor


def test_validate_excel_data_extraction_raises_with_invalid_excel_file_path():
    invalid_excel_file_path = "test.xlsx"
    valid_length_of_header = 1
    with pytest.raises(ValueError) as e:
        ExcelDataExtractor(
            invalid_excel_file_path, length_of_header=valid_length_of_header
        )
    assert str(e.value) == "Please provide an absolute path for the xlsx_path."


def test_validate_excel_data_extraction_raises_with_non_existent_excel_file_path():
    non_existent_excel_file_path = "/test.xlsx"
    valid_length_of_header = 1
    with pytest.raises(FileNotFoundError) as e:
        ExcelDataExtractor(
            non_existent_excel_file_path, length_of_header=valid_length_of_header
        )
    assert str(e.value) == f"The path {non_existent_excel_file_path} does not exist."


def test_validate_excel_data_extraction_raises_with_non_excel_file_with_absolute_path():
    non_excel_file_path = os.path.join(
        os.path.dirname(__file__), "test_data_csv_data_extraction.csv"
    )
    valid_length_of_header = 1
    with pytest.raises(ValueError) as e:
        ExcelDataExtractor(non_excel_file_path, length_of_header=valid_length_of_header)
    assert str(e.value) == f"The file {non_excel_file_path} must be an XLSX file."


def test_validate_excel_data_extraction_raises_with_invalid_type_length_of_header():
    valid_excel_file_path = os.path.join(
        os.path.dirname(__file__), "test_data_excel_data_extraction.xlsx"
    )
    invalid_length_of_header = "1"
    with pytest.raises(TypeError) as e:
        ExcelDataExtractor(
            valid_excel_file_path, length_of_header=invalid_length_of_header
        )
    assert str(e.value) == "length_of_header must be an integer."


def test_validate_excel_data_extraction_raises_with_zero_length_of_header():
    valid_excel_file_path = os.path.join(
        os.path.dirname(__file__), "test_data_excel_data_extraction.xlsx"
    )
    invalid_length_of_header = 0
    with pytest.raises(ValueError) as e:
        ExcelDataExtractor(
            valid_excel_file_path, length_of_header=invalid_length_of_header
        )
    assert str(e.value) == "length_of_header must be a positive integer."


def test_initialisation_excel_data_extraction_passes_with_valid_inputs():
    valid_excel_file_path = os.path.join(
        os.path.dirname(__file__), "test_data_excel_data_extraction.xlsx"
    )
    valid_length_of_header = 3
    extractor = ExcelDataExtractor(
        valid_excel_file_path, length_of_header=valid_length_of_header
    )
    assert extractor.xlsx_path == valid_excel_file_path
    assert extractor.length_of_header == valid_length_of_header


def test_read_data_excel_data_extraction_with_valid_inputs():
    valid_excel_file_path = os.path.join(
        os.path.dirname(__file__), "test_data_excel_data_extraction.xlsx"
    )
    valid_length_of_header = 3
    extractor = ExcelDataExtractor(
        valid_excel_file_path, length_of_header=valid_length_of_header
    )
    data = extractor.read_data_as_pandas_dataframe()
    assert isinstance(data, pd.DataFrame)
    assert isinstance(data.index, pd.DatetimeIndex)
    assert isinstance(data.columns, pd.MultiIndex)
    assert len(data.columns[0]) == 3  # 3 levels in the column index
